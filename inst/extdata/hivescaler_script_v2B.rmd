### Load data
```{r}
dat2017 <- data_load("~/hivescaler/inst/extdata/BM2017", tz = "EST")
dat2018 <- data_load("~/hivescaler/inst/extdata/BM2018", tz = "EST")
```

### Prep data for GAM nightly
```{r}
dat2017_proc_gam <- data_proc_gam(dat2017, ftrim = "2017-06-01", btrim = "2017-09-10",
                          omit = c("chestnuthill.1", "chestnuthill.2", "chestnuthill.3",
                                   "paradiso.1", "paradiso.2", "paradiso.3",
                                   "milt.1", "milt.2", "milt.3",
                                   "saul.2", "sofitel.3")) %>% # Chestnut Hill, Paradiso, and Milt are omitted because they were set up much later; Saul.2 and 
  filter(hour(TimeStamp_round) == 00:00:00) %>%
  group_by(ScaleID) %>%
  arrange(TimeStamp_round)


dat2018_proc_gam <- data_proc_gam(dat2018, ftrim = "2018-05-01", btrim = "2018-10-10",
                                          omit = c("paradiso.3", "rodeph.3", "westphilly.3",
                                                   "insectarium.1", "insectarium.2", "insectarium.3",
                                                   "share.1", "share.2", "share.3")) %>%
  filter(hour(TimeStamp_round) == 00:00:00) %>%
  group_by(ScaleID) %>%
  arrange(TimeStamp_round)
```


## We will follow the structure of the "GI" model of Pedersen et al. (2019): global smoother + site level smoothers with different wiggliness + site and colony random effects
```{r}
#### 2017
gam2017_mod3 <- gam(wt_recon ~ s(time, k = 20, m = 2, bs = "tp") + 
                     s(time, by = site, m = 1, k = 20, bs = "tp") +
                     s(site, bs = "re") +
                     s(ScaleID, bs = "re"),
                     data = dat2017_proc_gam,
                     method = "REML",
                     family = "gaussian")

draw(gam2017_mod3)
gam.check(gam2017_mod3)
concurvity(gam2017_mod3, full = TRUE)
summary(gam2017_mod3)

#### 2018
gam2018_mod3 <- gam(wt_recon ~ s(time, k = 20, m = 2, bs = "tp") + 
                     s(time, by = site, m = 1, k = 20, bs = "tp") +
                     s(site, bs = "re") +
                     s(ScaleID, bs = "re"),
                     data = dat2018_proc_gam,
                     method = "REML",
                     family = "gaussian")

draw(gam2018_mod3)
gam.check(gam2018_mod3)
concurvity(gam2018_mod3, full = TRUE)
summary(gam2018_mod3)

#### 2018
gam2018_mod3 <- gam(wt_recon ~ s(time, by = site, m = 1, k = 5, bs = "tp") +
                     s(site, bs = "re") +
                     s(ScaleID, bs = "re"),
                     data = dat2018_proc_gam,
                     method = "REML",
                     family = "gaussian")

draw(gam2018_mod3)
gam.check(gam2018_mod3)
concurvity(gam2018_mod3, full = TRUE)
summary(gam2018_mod3)

gam2018_mod3_hive <- gam(wt_recon ~ s(time, by = ScaleID, m = 1, k = 5, bs = "tp") +
                     s(site, bs = "re") +
                     s(ScaleID, bs = "re"),
                     data = dat2018_proc_gam,
                     method = "REML",
                     family = "gaussian")

draw(gam2018_mod3_hive)
gam.check(gam2018_mod3_hive)
concurvity(gam2018_mod3_hive, full = TRUE)
summary(gam2018_mod3_hive)
```

### Alternatively, we could use the simpler model in which site smoothers have the same wiggliness
```{r}
#### 2017
gam2017_mod2 <- gam(wt_recon ~ s(time, k = 20, m = 2, bs = "tp") + 
                     s(time, site, m = 2, k = 20, bs = "fs") +
                     s(ScaleID, bs = "re"),
                     data = dat2017_proc_gam,
                     method = "REML",
                     family = "gaussian")

draw(gam2017_mod2)
gam.check(gam2017_mod2)
concurvity(gam2017_mod2, full = TRUE)
summary(gam2017_mod2)

#### 2018
gam2018_mod2 <- gam(wt_recon ~ s(time, k = 20, m = 2, bs = "tp") + 
                     s(time, site, m = 2, k = 20, bs = "fs") +
                     s(ScaleID, bs = "re"),
                     data = dat2018_proc_gam,
                     method = "REML",
                     family = "gaussian")

draw(gam2018_mod2)
gam.check(gam2018_mod2)
concurvity(gam2018_mod2, full = TRUE)
summary(gam2018_mod2)
```

### Or, the simplest model
```{r}
#### 2017
gam2017_mod1 <- gam(wt_recon ~ s(time, k = 20, m = 2, bs = "tp") + 
                     s(site, bs = "re") +
                     s(ScaleID, bs = "re"),
                     data = dat2017_proc_gam,
                     method = "REML",
                     family = "gaussian")
draw(gam2017_mod1)
gam.check(gam2017_mod1)
concurvity(gam2017_mod1)
summary(gam2017_mod1)

#### 2018
gam2018_mod1 <- gam(wt_recon ~ s(time, k = 20, m = 2, bs = "tp") + 
                     s(site, bs = "re") +
                     s(ScaleID, bs = "re"),
                     data = dat2018_proc_gam,
                     method = "REML",
                     family = "gaussian")

draw(gam2018_mod1)
gam.check(gam2018_mod1)
concurvity(gam2018_mod1, full = TRUE)
summary(gam2018_mod1)
```

### Model selection
```{r}
BIC(gam2017_mod1, gam2017_mod2, gam2017_mod3)
BIC(gam2018_mod1, gam2018_mod2, gam2018_mod3)
```


### Another way to do this is to model group smooths for both colony and site
```{r}
#### 2017
gam2017_mod2 <- gam(wt_recon ~ s(time, k = 10, m = 2, bs = "tp") + 
                      s(time, ScaleID, m = 2, k = 10, bs = "fs") +
                      s(time, site, m = 2, k = 10, bs = "fs"),
                    data = dat2017_proc_gam,
                    method = "REML",
                    family = "gaussian")

draw(gam2017_mod2)
gam.check(gam2017_mod2)
concurvity(gam2017_mod2, full = TRUE)
summary(gam2017_mod2)

#### 2018
gam2018_mod2 <- gam(wt_recon ~ s(time, k = 20, m = 2, bs = "tp") + 
                     s(time, ScaleID, m = 2, k = 20, bs = "fs") +
                     s(site, bs = "re"),
                     data = dat2018_proc_gam,
                     method = "REML",
                     family = "gaussian")

draw(gam2018_mod2)
gam.check(gam2018_mod2)
concurvity(gam2018_mod2, full = TRUE)
summary(gam2018_mod2)
```


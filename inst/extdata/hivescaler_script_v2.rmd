### Load data
```{r}
dat2017 <- data_load("~/hivescaler/inst/extdata/BM2017", tz = "EST")
dat2018 <- data_load("~/hivescaler/inst/extdata/BM2018", tz = "EST")
```

### Prep data for GAM nightly
```{r}
dat2017_proc_gam <- data_proc_gam(dat2017, ftrim = "2017-06-01", btrim = "2017-09-10",
                          omit = c("chestnuthill.1", "chestnuthill.2", "chestnuthill.3",
                                   "paradiso.1", "paradiso.2", "paradiso.3",
                                   "milt.1", "milt.2", "milt.3",
                                   "saul.2", "sofitel.3")) %>% # Chestnut Hill, Paradiso, and Milt are omitted because they were set up much later; Saul.2 and 
  filter(hour(TimeStamp_round) == 00:00:00) %>%
  group_by(ScaleID) %>%
  arrange(TimeStamp_round) %>%
  mutate(nightly_diff = c(NA, diff(wt_recon)))


dat2018_proc_gam <- data_proc_gam(dat2018, ftrim = "2018-05-01", btrim = "2018-10-10",
                                          omit = c("paradiso.3", "rodeph.3", "westphilly.3",
                                                   "insectarium.1", "insectarium.2", "insectarium.3",
                                                   "share.1", "share.2", "share.3")) %>%
  filter(hour(TimeStamp_round) == 00:00:00) %>%
  group_by(ScaleID) %>%
  arrange(TimeStamp_round) %>%
  mutate(nightly_diff = c(NA, diff(wt_recon)))
```

### Prelim visualization
```{r}
ggplot(dat2018_proc_gam, aes(TimeStamp_round, wt_recon, color = ScaleID)) +
  geom_line() +
  facet_wrap(~site)
```

## In the following sections, we will follow the structure of Pedersen et al. (2019) by adapting mixed models 1-5 to our data
### Model 0: Global smoother, no random effects
```{r}
#### 2017
gam2017_mod0 <- gam(nightly_diff ~ s(time, k = 20, m = 2, bs = "tp"),
                     data = dat2017_proc_gam,
                     method = "REML",
                     family = "scat")

draw(gam2017_mod0)
gam.check(gam2017_mod0)

#### 2018
gam2018_mod0 <- gam(nightly_diff ~ s(time, k = 20, m = 2, bs = "tp"),
                     data = dat2018_proc_gam,
                     method = "REML",
                     family = "scat")

draw(gam2018_mod0)
gam.check(gam2018_mod0)
summary(gam2018_mod0)

draw(gam2018_mod0)
fitted <- gam2018_mod0$fitted.values

dates <- as_datetime(gam2018_mod0$model$time)
pdat <- tibble(dates, fitted)
appraise(gam2018_mod0)
p <- getViz(gam2018_mod0)
plot(p, select = 1)

ggplot(pdat, aes(x = dates, y = fitted)) +
  geom_line(alpha = 1) +
  geom_hline(yintercept = 0, color = "red") +
  ylab("Daily weight change") +
  xlab("Date")
ggsave("~/Desktop/delta_curve.png", height = 4, width = 8)
```


### Model 1: Global smoother + random effects of site and colony
```{r}
#### 2017
gam2017_mod1 <- gam(nightly_diff ~ s(time, k = 20, m = 2, bs = "tp") + 
                     s(site, bs = "re") +
                     s(ScaleID, bs = "re"),
                     data = dat2017_proc_gam,
                     method = "REML",
                     family = "scat")
draw(gam2017_mod1)
gam.check(gam2017_mod1)
concurvity(gam2017_mod1)
summary(gam2017_mod1)

#### 2018
gam2018_mod1 <- gam(nightly_diff ~ s(time, k = 20, m = 2, bs = "tp") + 
                     s(site, bs = "re") +
                     s(ScaleID, bs = "re"),
                     data = dat2018_proc_gam,
                     method = "REML",
                     family = "scat") # data is over dispersed; scat family deals with this

draw(gam2018_mod1)
gam.check(gam2018_mod1)
concurvity(gam2018_mod1, full = TRUE)
summary(gam2018_mod1)

###### Plot with dates
fitted <- gam2018_mod1$fitted.values
dates <- as_datetime(gam2018_mod1$model$time)
pdat <- tibble(dates, fitted)
ggplot(pdat, aes(x = dates, y = fitted)) +
  geom_point(alpha = 0.1)

p <- getViz(gam2018_mod1)
plot(p, select = 1)
```

### Model 2: Global smoother + group level smoothers with same wiggliness
```{r}
#### 2017
gam2017_mod2 <- gam(nightly_diff ~ s(time, k = 20, m = 2, bs = "tp") + 
                     s(time, site, m = 2, bs = "fs") +
                     s(ScaleID, bs = "re"),
                     data = dat2017_proc_gam,
                     method = "REML",
                     family = "scat")

draw(gam2017_mod2)
gam.check(gam2017_mod2)
concurvuty(gam2017_mod2, full = TRUE)
summary(gam2017_mod2)

#### 2018
gam2018_mod2 <- gam(nightly_diff ~ s(time, k = 20, m = 2, bs = "tp") + 
                     s(time, site, m = 2, bs = "fs") +
                     s(ScaleID, bs = "re"),
                     data = dat2018_proc_gam,
                     method = "REML",
                     family = "scat")

draw(gam2018_mod2)
gam.check(gam2018_mod2)
concurvity(gam2018_mod2, full = TRUE)
summary(gam2018_mod2)
```


### Model 3: Global smoother + group level smoothers with different wiggliness
```{r}
#### 2017
gam2017_mod3 <- gam(nightly_diff ~ s(time, k = 20, m = 2, bs = "tp") + 
                     s(time, by = site, m = 1, k = 20, bs = "tp") +
                     s(site, bs = "re") +
                     s(ScaleID, bs = "re"),
                     data = dat2017_proc_gam,
                     method = "REML",
                     family = "scat")

draw(gam2017_mod3)
gam.check(gam2017_mod3)
summary(gam2017_mod3)

#### 2018
gam2018_mod3 <- gam(nightly_diff ~ s(time, k = 20, m = 2, bs = "tp") + 
                     s(time, by = site, m = 1, k = 20, bs = "tp") +
                     s(site, bs = "re") +
                     s(ScaleID, bs = "re"),
                     data = dat2018_proc_gam,
                     method = "REML",
                     family = "scat")

draw(gam2018_mod3)
gam.check(gam2018_mod3)
```


### Model 4: Group-specific smoothers without a global smoother, but with all smoothers having the same wiggliness.
```{r}
gam2018_mod4 <- gam(nightly_diff ~ s(time, site, k = 20, m = 2, bs = "fs") +
                     s(ScaleID, bs = "re"),
                     data = dat2018_proc_gam,
                     method = "REML",
                     family = "scat")

draw(gam2018_mod4)
gam.check(gam2018_mod4)
summary(gam2018_mod4)
```

### Model 5: Group-specific smoothers with different wiggliness
```{r}
gam2018_mod5 <- gam(nightly_diff ~ s(time, by = site, m = 1, k = 20, bs = "ts") +
                     s(site, bs = "re") +
                     s(ScaleID, bs = "re"),
                     data = dat2018_proc_gam,
                     method = "REML",
                     family = "scat")

draw(gam2018_mod5)
gam.check(gam2018_mod5)
summary(gam2018_mod5)
concurvity(gam2018_mod5)
```

### Model selection
```{r}
AIC(gam2018_mod0, gam2018_mod1, gam2018_mod2, gam2018_mod3)
```
